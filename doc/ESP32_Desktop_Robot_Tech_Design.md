# ESP32 桌面机器人技术方案选型（端轻云重）

## 1. 项目目标

构建一台基于 **ESP32** 的桌面机器人，具备基础感知、动作与联网能力，
所有“智能决策”集中在服务端完成。

核心设计思想：

> **语义在云端，物理约束在终端**

---

## 2. 总体系统架构

```
┌──────────────┐
│  桌面机器人  │  ESP32
│──────────────│
│ 摄像头       │
│ 麦克风       │
│ 舵机（俯仰） │
│ 扬声器       │
│ WiFi         │
└──────▲───────┘
       │ WebSocket 长连接
       ▼
┌──────────────────────┐
│       服务端系统     │
│──────────────────────│
│ 连接管理 / 会话状态  │
│ ASR / Vision         │
│ LLM 决策             │
│ 行为规划             │
│ TTS                  │
└──────────────────────┘
```

---

## 3. 端侧（ESP32）技术选型

### 3.1 硬件选型

- MCU：**ESP32-S3**
  - RAM 较大，适合 Camera + I2S
  - USB 原生支持
- 舵机：标准 PWM 舵机（1 轴俯仰）
- 摄像头：ESP32 Camera（低分辨率、低帧率）
- 麦克风：I2S 数字麦克风
- 扬声器：I2S / DAC

---

### 3.2 端侧职责边界

ESP32 只负责 **执行与传输**，不承担智能决策：

- 建立 WiFi 与长连接
- 采集并上传：
  - 音频流（分片）
  - 图像帧
- 接收并执行：
  - 语义动作指令
- 本地完成：
  - 舵机角度计算
  - 时间调度
  - 安全与异常过滤

---

## 4. 通信方案

### 4.1 协议选型

**推荐：WebSocket**

原因：
- 双向实时通信
- 易承载音频 / 图像 / 控制指令
- 服务端与 MCU 实现成熟

---

### 4.2 消息类型

#### ESP32 → 服务端
- 音频数据（PCM / Opus）
- 图像帧（JPEG）
- 心跳 / 状态

#### 服务端 → ESP32
- 语义动作指令
- 音频播放数据
- 控制类指令

---

## 5. 语义动作指令设计（核心）

### 5.1 服务端指令原则

- 只描述 **“想做什么”**
- 不包含角度、PWM 等物理细节
- 不依赖具体硬件结构

示例：

```json
{
  "type": "posture",
  "action": "look_up",
  "duration_ms": 3000
}
```

---

### 5.2 端侧动作映射

ESP32 内部维护动作映射表：

| 语义动作 | 相对角度 |
|---------|---------|
| look_up | +12° |
| look_down | -10° |
| neutral | 0° |

服务端永远不感知角度细节。

---

## 6. 安全与异常控制（端侧）

### 6.1 时间过滤

- 最小执行时间：200 ms
- 最大执行时间：5000 ms
- 超出范围自动 clamp

即使收到异常值（如 1000 秒），也不会造成风险。

---

### 6.2 角度限幅

- 所有目标角度必须限制在物理安全区间
- 防止：
  - LLM 幻觉
  - 协议错误
  - 恶意输入

---

## 7. 动作执行模型

采用 **非阻塞状态机**：

```
IDLE
 → MOVE_TO_TARGET
 → HOLD
 → RETURN
 → IDLE
```

- Tick 驱动（20ms / 50ms）
- 不使用 delay 阻塞
- 便于后续并发与打断扩展

---

## 8. 服务端职责

服务端负责：

- 连接与会话管理
- 音频识别（ASR）
- 图像理解（Vision）
- 多模态信息融合
- LLM 决策
- 行为规划（输出语义动作）
- TTS 音频生成

---

## 9. 方案优势总结

- LLM 出错 ≠ 物理事故
- 端侧可独立保证安全
- 多机器人型号可复用同一语义协议
- 更换舵机或结构无需改服务端
- 符合“云端大脑 + 终端身体”的机器人形态

---

## 10. 后续可扩展方向

- 动作优先级与打断
- ACK / NACK 回执机制
- 本地 fallback 行为
- 多机器人统一语义协议
