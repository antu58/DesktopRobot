# Soul-Body 全局通信协议 v2

更新时间：2026-02-22  
状态：`实施中（Phase 1）`  
适用范围：`Body`（硬件终端）、网关、`soul-server`

## 1. 文档定位

本文件是 Soul 与 Body 共享的通信协议基线（source of truth）。  
涉及 MQTT 与 HTTP 的字段、时序、约束均以本文件为准。
API 字段定义请参考：`../Soul/docs/API文档-Soul服务.md`。

## 2. 总体流程

1. Body 连接 MQTT 并设置遗嘱（`online=offline`）。
2. Body 连接成功后按顺序上报：`online` -> `skills` -> `intent_catalog` -> `heartbeat`。
3. 网关或 Body 调用 `POST /v1/chat`，传输 `inputs[]`。
4. `soul-server` 基于终端 skills 做 LLM tool 调度（默认单次 LLM）。
5. 默认流程：LLM 选择终端技能 -> 服务端 MQTT `invoke` 下发 -> Body 回传 `result`。
6. 特殊流程：若 LLM 选择内置 `recall_memory`，服务端先同步下发 `status=mem0_searching`，查询 Mem0 后再进行第二次 LLM 并执行终端技能。
7. `recall_memory` 暴露受 Mem0 就绪状态控制：Mem0 未就绪时不暴露该技能，避免无效二次推理。
8. 会话空闲 3 分钟触发总结与异步记忆流程（不阻塞主链路）。

会话活跃判定规则（当前实现）：

- 以 `/v1/chat` 中的用户输入为唯一活动信号。
- 每次成功写入 `role=user` 消息时，服务端重置该会话的 3 分钟计时。
- 连续 3 分钟无新输入时，触发空闲总结。

## 3. MQTT 协议

默认 `prefix=soul`。

## 3.1 Topic

- 在线状态：`{prefix}/terminal/{terminalId}/online`
- 设备心跳：`{prefix}/terminal/{terminalId}/heartbeat`
- 技能快照：`{prefix}/terminal/{terminalId}/skills`
- 意图快照：`{prefix}/terminal/{terminalId}/intent_catalog`
- 技能调用：`{prefix}/terminal/{terminalId}/invoke/{requestId}`
- 执行回执：`{prefix}/terminal/{terminalId}/result/{requestId}`
- 状态通知：`{prefix}/terminal/{terminalId}/status`

## 3.2 QoS / Retain

- `online`：QoS 1，Retain=true
- `skills`：QoS 1，Retain=true
- `intent_catalog`：QoS 1，Retain=true
- `heartbeat`：QoS 0，Retain=false
- `invoke/result`：QoS 1，Retain=false
- `status`：QoS 1，Retain=false

## 3.3 `skills`（初始化必做）

`skills` 是 Body 连接后初始化行为的一部分，必须在上线后立即上报。

Topic：`{prefix}/terminal/{terminalId}/skills`

Payload（标准）：

```json
{
  "terminal_id": "terminal-001",
  "soul_hint": "friendly",
  "skill_version": 3,
  "skills": [
    {
      "name": "head_up",
      "description": "抬头",
      "input_schema": {
        "type": "object",
        "properties": {
          "angle": { "type": "integer", "minimum": 0, "maximum": 30 },
          "duration_seconds": { "type": "number", "minimum": 0.1, "maximum": 10 }
        },
        "required": ["angle", "duration_seconds"]
      }
    }
  ]
}
```

字段约束：

- `terminal_id`：建议必填，且必须与 topic 中 `{terminalId}` 一致。
- `soul_hint`：可选，仅用于首次绑定灵魂。
- `skill_version`：建议必填且大于 0。
- `skills`：必填数组，可为空（表示无可用技能）。
- `skills[].name`：必填，建议 snake_case，单快照内唯一。
- `skills[].description`：建议包含“用途/效果/约束”（例如互斥、是否可并行、何时不应调用）。
- `skills[].input_schema`：建议必填 JSON Schema；无参数技能使用空 object schema。

版本规则（当前服务端实现）：

- `Vcur>0` 且 `Vnew>0 && Vnew<Vcur`：忽略（防止回滚）。
- `Vcur>0` 且 `Vnew=0`：忽略。
- `Vnew=Vcur`：允许覆盖（幂等重发）。
- 建议：技能集合或 schema 有变化时，`skill_version += 1`。

兼容格式（不推荐）：

- 仅发 `skills[]` 数组（无对象包裹）可被兼容解析，但会丢失 `skill_version/soul_hint/terminal_id` 语义。

## 3.4 `online`

Topic：`{prefix}/terminal/{terminalId}/online`  
Payload：`online` / `offline`（或 `true/false`, `1/0`）

要求：

- 必须设置 LWT：异常断开时自动发布 `offline`。
- 连接成功后立即发布 `online`。

## 3.5 `heartbeat`

Topic：`{prefix}/terminal/{terminalId}/heartbeat`  
Payload：建议固定 `"1"`。

要求：

- 周期建议 10 秒。
- 周期必须小于服务端技能快照 TTL（默认 60 秒）以避免能力过期。

## 3.6 `invoke` / `result`

下发 Topic：`{prefix}/terminal/{terminalId}/invoke/{requestId}`

```json
{
  "request_id": "uuid",
  "skill": "head_up",
  "arguments": {
    "angle": 15,
    "duration_seconds": 3
  }
}
```

回执 Topic：`{prefix}/terminal/{terminalId}/result/{requestId}`

```json
{
  "request_id": "uuid",
  "ok": true,
  "output": "head_up executed"
}
```

失败示例：

```json
{
  "request_id": "uuid",
  "ok": false,
  "output": "head_up failed",
  "error": "servo timeout"
}
```

要求：

- 回执必须带 `request_id`。
- `ok=false` 时必须提供 `error`。
- 建议回执在 5 秒内返回；当前服务端编排超时默认约 8 秒。

## 3.7 `status`（服务端 -> Body）

用于服务端同步通知终端当前处理阶段，便于展示“思考中/查询中”状态。

Topic：`{prefix}/terminal/{terminalId}/status`

示例：

```json
{
  "status": "mem0_searching",
  "message": "正在回顾历史记忆，请稍候。",
  "session_id": "s1",
  "ts": "2026-02-20T16:20:00Z"
}
```

当前约定的 `status`：

- `mem0_searching`：开始查询 Mem0。
- `mem0_search_done`：查询完成，继续推理。
- `mem0_search_failed`：查询失败，降级继续推理。

## 3.8 `intent_catalog`（初始化必做）

`intent_catalog` 与 `skills` 同属连接初始化阶段，必须在上线时上报。

Topic：`{prefix}/terminal/{terminalId}/intent_catalog`

Payload（示例）：

```json
{
  "terminal_id": "terminal-001",
  "catalog_version": 12,
  "intent_catalog": [
    {
      "id": "light_off",
      "name": "关灯",
      "priority": 90,
      "match": {
        "keywords_any": ["关", "关闭", "灯"]
      },
      "slots": [
        {"name": "action", "required": true, "from_entity_types": ["action"]},
        {"name": "device", "required": true, "from_entity_types": ["device"]},
        {"name": "room", "from_entity_types": ["room"]}
      ]
    }
  ]
}
```

字段约束：

- `terminal_id`：建议必填，且必须与 topic 中 `{terminalId}` 一致。
- `catalog_version`：建议必填且大于 0；内容变化时递增。
- `intent_catalog`：必填数组，可为空（表示该终端本次无业务意图能力）。
- `intent_catalog[]` 结构需与 `intent-filter` 请求中 `intent_catalog[]` 一致。

时序与重连规则（强约束）：

- 每次终端连接都必须完整上报一次 `intent_catalog`（不做增量）。
- 每次断线重连都必须再次完整上报。
- 推荐时序：`online -> skills -> intent_catalog -> heartbeat`。

## 4. HTTP 协议

## 4.1 `POST /v1/chat`

请求：

```json
{
  "user_id": "demo-user",
  "session_id": "s1",
  "terminal_id": "terminal-001",
  "soul_hint": "friendly",
  "inputs": [
    {
      "input_id": "in-001",
      "type": "keyboard_text",
      "source": "keyboard",
      "ts": "2026-02-20T12:00:01Z",
      "text": "今天上海天气如何？"
    }
  ]
}
```

字段约束：

- `session_id`：必填。
- `terminal_id`：必填。
- `inputs`：必填，至少 1 项。
- 当前 Phase 1：至少存在 1 条非空 `keyboard_text`。

输入类型：

- 文本类：`keyboard_text`、`speech_text`、`event_note`
- 传感器类：`presence`、`sensor_state`
- 媒体类：`audio`、`image`、`video`

媒体类约定：

- 原始文件先上传 OSS。
- `inputs[].media` 仅上传地址与元数据，服务端按策略拉取处理。

## 4.2 响应

```json
{
  "session_id": "s1",
  "terminal_id": "terminal-001",
  "soul_id": "soul_xxx",
  "reply": "好的，我已处理。",
  "executed_skills": ["recall_memory", "head_up"],
  "context_summary": "本轮会话压缩摘要"
}
```

## 4.3 `intent-filter`（意图注入与筛选协议）

本节定义 `soul-server -> intent-filter` 的内部 HTTP 协议。

目标：

- 主服务注入“当前可用意图集合（intent catalog）”。
- 子服务只做意图筛选与参数结构化，不做技能调用。
- 子服务明确返回路由决策，避免主服务二次猜测。

### 4.3.1 请求（`POST /v1/intents/filter`）

```json
{
  "request_id": "optional",
  "command": "帮我关闭卧室的灯并且提醒我10分钟后取快递",
  "intent_catalog": [
    {
      "id": "light_off",
      "name": "关灯",
      "priority": 90,
      "match": {
        "keywords_any": ["关", "关闭", "灯"],
        "entity_types_any": ["action", "device"],
        "min_confidence": 0.35
      },
      "slots": [
        {"name": "action", "required": true, "from_entity_types": ["action"]},
        {"name": "device", "required": true, "from_entity_types": ["device"]},
        {"name": "room", "from_entity_types": ["room"]}
      ]
    }
  ],
  "options": {
    "allow_multi_intent": true,
    "max_intents": 8,
    "max_intents_per_segment": 1,
    "min_confidence": 0.35,
    "enable_time_parser": true,
    "emit_system_intent_when_empty": true,
    "return_debug_candidates": false,
    "return_debug_entities": false
  }
}
```

字段约束：

- `command`：必填，本轮用户命令文本（主服务无需额外传实体）。
- `intent_catalog`：必填数组，表示本轮可识别意图集合；空数组不允许。
- `intent_catalog[].id`：必填，单请求内唯一，建议 snake_case。
- `intent_catalog[].match`：意图匹配规则（关键词/正则/实体类型/示例相似度）。
- `intent_catalog[].slots`：槽位映射规则（实体来源、时间来源、正则、默认值）。
- `options.emit_system_intent_when_empty`：建议保持 `true`，用于统一空命中行为。

注入方式规范：

- 注入时机（规范）：终端每次连接服务端时，与 `skills` 同阶段上传一次完整 `intent_catalog` 快照。
- 重连规则（规范）：每次断线重连都必须重新上传全量 `intent_catalog`，不做增量补丁。
- 运行时使用：`soul-server` 可缓存连接期的 `intent_catalog`，并在每轮调用 `intent-filter` 时携带该快照。
- 注入内容：仅注入“当前终端可执行/可处理”的意图，不应注入无效意图。
- 版本管理：若主服务维护意图版本，建议在快照中附带版本号并在日志中关联（协议不强制字段名）。

### 4.3.2 响应

```json
{
  "request_id": "ifr_xxx",
  "decision": {
    "action": "execute_intents",
    "trigger_intent_id": "light_off",
    "reason": "matched_catalog_intents"
  },
  "intents": [
    {
      "intent_id": "light_off",
      "intent_name": "关灯",
      "confidence": 0.54,
      "status": "ready",
      "segment_index": 0,
      "span": {"text": "关闭卧室的灯", "start": 0, "end": 6},
      "parameters": {"action": "close", "device": "light", "room": "bedroom"},
      "normalized": {},
      "missing_parameters": [],
      "evidence": [{"type": "keyword_any", "value": "灯", "score": 1.0}]
    }
  ],
  "meta": {
    "latency_ms": 0.9,
    "segment_count": 2,
    "catalog_size": 2,
    "time_signals": 1,
    "timezone": "Asia/Shanghai",
    "locale": "zh-CN",
    "now": "2026-02-22T17:40:00+08:00"
  }
}
```

核心语义：

- `decision.action`
  - `execute_intents`：主服务执行 `intents[]`。
  - `fallback_reasoning`：主服务触发高级模型思考。
  - `no_action`：主服务不执行动作（可记录/情绪回应）。
- `intents[].status`
  - `ready`：槽位完整，可直接执行。
  - `need_clarification`：缺少必填槽位，应追问或升级。
  - `rejected`：识别但判定不可执行（保留位）。
  - `system`：系统意图（非业务技能意图）。

### 4.3.3 默认系统意图（规范）

- `sys.fallback_reasoning`
  - 含义：业务意图不明确或讨论型问题，建议主服务走高级模型。
  - 对应 `decision.action=fallback_reasoning`。
- `sys.no_action`
  - 含义：用户仅情绪表达/感叹（如“吓我一跳”），不应触发设备/任务动作。
  - 对应 `decision.action=no_action`。

要求：

- 当 `emit_system_intent_when_empty=true` 且未命中业务意图时，必须返回上述系统意图之一。
- 主服务必须优先以 `decision.action` 驱动路由，不应仅依赖 `intents[0].intent_id`。

## 5. 兼容与演进

- 协议版本：`v2`。
- 服务端接口已收口为 `inputs[]`；历史 `message/sensor_events/raw_inputs` 不再作为标准输入。
- Phase 1 当前只把 `keyboard_text` 纳入主推理，其他输入类型按协议保留结构，后续逐步实现。

## 6. 联调检查清单

1. MQTT 连接后是否按 `online -> skills -> intent_catalog -> heartbeat` 顺序上报。
2. `skills` 的 `terminal_id` 与 topic 终端 ID 是否一致。
3. `skill_version` 是否单调不回退。
4. `invoke` 是否能按 `request_id` 回传 `result`。
5. `/v1/chat` 是否始终携带 `inputs[]`，且含非空 `keyboard_text`。
6. 连续 3 分钟无新 `/v1/chat` 用户输入时，是否触发空闲总结。
7. 终端是否在每次连接（含重连）按 `online -> skills -> intent_catalog -> heartbeat` 上报。
8. `intent_catalog` 注入是否仅包含当前终端可处理意图。
9. 未命中业务意图时，是否稳定返回 `sys.fallback_reasoning` 或 `sys.no_action`。
10. 主服务路由是否以 `decision.action` 为准（而非猜测）。
