# Soul-Body 全局通信协议 v2

更新时间：2026-02-20  
状态：`实施中（Phase 1）`  
适用范围：`Body`（硬件终端）、网关、`soul-server`

## 1. 文档定位

本文件是 Soul 与 Body 共享的通信协议基线（source of truth）。  
涉及 MQTT 与 HTTP 的字段、时序、约束均以本文件为准。
API 字段定义请参考：`../Soul/docs/API文档-Soul服务.md`。

## 2. 总体流程

1. Body 连接 MQTT 并设置遗嘱（`online=offline`）。
2. Body 连接成功后按顺序上报：`online` -> `skills` -> `heartbeat`。
3. 网关或 Body 调用 `POST /v1/chat`，传输 `inputs[]`。
4. `soul-server` 基于终端 skills 做 LLM tool 调度。
5. 服务端通过 MQTT `invoke` 下发技能，Body 回传 `result`。
6. 会话空闲 3 分钟触发总结与异步记忆流程（不阻塞主链路）。

会话活跃判定规则（当前实现）：

- 以 `/v1/chat` 中的用户输入为唯一活动信号。
- 每次成功写入 `role=user` 消息时，服务端重置该会话的 3 分钟计时。
- 连续 3 分钟无新输入时，触发空闲总结。

## 3. MQTT 协议

默认 `prefix=soul`。

## 3.1 Topic

- 在线状态：`{prefix}/terminal/{terminalId}/online`
- 设备心跳：`{prefix}/terminal/{terminalId}/heartbeat`
- 技能快照：`{prefix}/terminal/{terminalId}/skills`
- 技能调用：`{prefix}/terminal/{terminalId}/invoke/{requestId}`
- 执行回执：`{prefix}/terminal/{terminalId}/result/{requestId}`

## 3.2 QoS / Retain

- `online`：QoS 1，Retain=true
- `skills`：QoS 1，Retain=true
- `heartbeat`：QoS 0，Retain=false
- `invoke/result`：QoS 1，Retain=false

## 3.3 `skills`（初始化必做）

`skills` 是 Body 连接后初始化行为的一部分，必须在上线后立即上报。

Topic：`{prefix}/terminal/{terminalId}/skills`

Payload（标准）：

```json
{
  "terminal_id": "terminal-001",
  "soul_hint": "friendly",
  "skill_version": 3,
  "skills": [
    {
      "name": "head_up",
      "description": "抬头",
      "input_schema": {
        "type": "object",
        "properties": {
          "angle": { "type": "integer", "minimum": 0, "maximum": 30 },
          "duration_seconds": { "type": "number", "minimum": 0.1, "maximum": 10 }
        },
        "required": ["angle", "duration_seconds"]
      }
    }
  ]
}
```

字段约束：

- `terminal_id`：建议必填，且必须与 topic 中 `{terminalId}` 一致。
- `soul_hint`：可选，仅用于首次绑定灵魂。
- `skill_version`：建议必填且大于 0。
- `skills`：必填数组，可为空（表示无可用技能）。
- `skills[].name`：必填，建议 snake_case，单快照内唯一。
- `skills[].input_schema`：建议必填 JSON Schema；无参数技能使用空 object schema。

版本规则（当前服务端实现）：

- `Vcur>0` 且 `Vnew>0 && Vnew<Vcur`：忽略（防止回滚）。
- `Vcur>0` 且 `Vnew=0`：忽略。
- `Vnew=Vcur`：允许覆盖（幂等重发）。
- 建议：技能集合或 schema 有变化时，`skill_version += 1`。

兼容格式（不推荐）：

- 仅发 `skills[]` 数组（无对象包裹）可被兼容解析，但会丢失 `skill_version/soul_hint/terminal_id` 语义。

## 3.4 `online`

Topic：`{prefix}/terminal/{terminalId}/online`  
Payload：`online` / `offline`（或 `true/false`, `1/0`）

要求：

- 必须设置 LWT：异常断开时自动发布 `offline`。
- 连接成功后立即发布 `online`。

## 3.5 `heartbeat`

Topic：`{prefix}/terminal/{terminalId}/heartbeat`  
Payload：建议固定 `"1"`。

要求：

- 周期建议 10 秒。
- 周期必须小于服务端技能快照 TTL（默认 60 秒）以避免能力过期。

## 3.6 `invoke` / `result`

下发 Topic：`{prefix}/terminal/{terminalId}/invoke/{requestId}`

```json
{
  "request_id": "uuid",
  "skill": "head_up",
  "arguments": {
    "angle": 15,
    "duration_seconds": 3
  }
}
```

回执 Topic：`{prefix}/terminal/{terminalId}/result/{requestId}`

```json
{
  "request_id": "uuid",
  "ok": true,
  "output": "head_up executed"
}
```

失败示例：

```json
{
  "request_id": "uuid",
  "ok": false,
  "output": "head_up failed",
  "error": "servo timeout"
}
```

要求：

- 回执必须带 `request_id`。
- `ok=false` 时必须提供 `error`。
- 建议回执在 5 秒内返回；当前服务端编排超时默认约 8 秒。

## 4. HTTP 协议

## 4.1 `POST /v1/chat`

请求：

```json
{
  "user_id": "demo-user",
  "session_id": "s1",
  "terminal_id": "terminal-001",
  "soul_hint": "friendly",
  "inputs": [
    {
      "input_id": "in-001",
      "type": "keyboard_text",
      "source": "keyboard",
      "ts": "2026-02-20T12:00:01Z",
      "text": "今天上海天气如何？"
    }
  ]
}
```

字段约束：

- `session_id`：必填。
- `terminal_id`：必填。
- `inputs`：必填，至少 1 项。
- 当前 Phase 1：至少存在 1 条非空 `keyboard_text`。

输入类型：

- 文本类：`keyboard_text`、`speech_text`、`event_note`
- 传感器类：`presence`、`sensor_state`
- 媒体类：`audio`、`image`、`video`

媒体类约定：

- 原始文件先上传 OSS。
- `inputs[].media` 仅上传地址与元数据，服务端按策略拉取处理。

## 4.2 响应

```json
{
  "session_id": "s1",
  "terminal_id": "terminal-001",
  "soul_id": "soul_xxx",
  "reply": "好的，我已处理。",
  "executed_skills": ["head_up"],
  "context_summary": "本轮会话压缩摘要"
}
```

## 5. 兼容与演进

- 协议版本：`v2`。
- 服务端接口已收口为 `inputs[]`；历史 `message/sensor_events/raw_inputs` 不再作为标准输入。
- Phase 1 当前只把 `keyboard_text` 纳入主推理，其他输入类型按协议保留结构，后续逐步实现。

## 6. 联调检查清单

1. MQTT 连接后是否按 `online -> skills -> heartbeat` 顺序上报。
2. `skills` 的 `terminal_id` 与 topic 终端 ID 是否一致。
3. `skill_version` 是否单调不回退。
4. `invoke` 是否能按 `request_id` 回传 `result`。
5. `/v1/chat` 是否始终携带 `inputs[]`，且含非空 `keyboard_text`。
6. 连续 3 分钟无新 `/v1/chat` 用户输入时，是否触发空闲总结。
