services:
  postgres:
    image: postgres:16-alpine
    container_name: soul-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 10

  mqtt:
    image: eclipse-mosquitto:2
    container_name: soul-mqtt
    volumes:
      - ./mqtt/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    ports:
      - "1883:1883"

  mem0-postgres:
    image: ankane/pgvector:v0.5.1
    container_name: mem0-postgres
    environment:
      POSTGRES_USER: ${MEM0_POSTGRES_USER}
      POSTGRES_PASSWORD: ${MEM0_POSTGRES_PASSWORD}
      POSTGRES_DB: ${MEM0_POSTGRES_DB}
    volumes:
      - mem0-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-q", "-d", "${MEM0_POSTGRES_DB}", "-U", "${MEM0_POSTGRES_USER}"]
      interval: 5s
      timeout: 5s
      retries: 10

  mem0-neo4j:
    image: neo4j:5.26.4
    container_name: mem0-neo4j
    environment:
      NEO4J_AUTH: ${MEM0_NEO4J_AUTH}
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_apoc_export_file_enabled: "true"
      NEO4J_apoc_import_file_enabled: "true"
      NEO4J_apoc_import_file_use__neo4j__config: "true"
    volumes:
      - mem0-neo4j-data:/data
    ports:
      - "${MEM0_NEO4J_HTTP_PORT}:7474"
      - "${MEM0_NEO4J_BOLT_PORT}:7687"
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:7474 || exit 1"]
      interval: 5s
      timeout: 10s
      retries: 20

  mem0:
    build:
      context: ./mem0-server
      dockerfile: Dockerfile
      args:
        HTTP_PROXY: ${DOCKER_HTTP_PROXY}
        HTTPS_PROXY: ${DOCKER_HTTPS_PROXY}
        ALL_PROXY: ${DOCKER_ALL_PROXY}
    container_name: mem0
    env_file:
      - .env
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      POSTGRES_HOST: mem0-postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${MEM0_POSTGRES_DB}
      POSTGRES_USER: ${MEM0_POSTGRES_USER}
      POSTGRES_PASSWORD: ${MEM0_POSTGRES_PASSWORD}
      POSTGRES_COLLECTION_NAME: ${MEM0_POSTGRES_COLLECTION_NAME}
      NEO4J_URI: bolt://mem0-neo4j:7687
      NEO4J_USERNAME: ${MEM0_NEO4J_USERNAME}
      NEO4J_PASSWORD: ${MEM0_NEO4J_PASSWORD}
    depends_on:
      mem0-postgres:
        condition: service_healthy
      mem0-neo4j:
        condition: service_healthy
    ports:
      - "${MEM0_HTTP_PORT}:8000"

  soul-server:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP: soul-server
    container_name: soul-server
    env_file:
      - .env
    environment:
      SOUL_HTTP_ADDR: :9010
      MQTT_BROKER_URL: tcp://mqtt:1883
      DB_DSN: ${DB_DSN}
      MEM0_BASE_URL: http://mem0:8000
    depends_on:
      postgres:
        condition: service_healthy
      mqtt:
        condition: service_started
    ports:
      - "${SOUL_HTTP_PORT}:9010"

  terminal-web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP: terminal-web
    container_name: terminal-web
    env_file:
      - .env
    environment:
      TERMINAL_WEB_HTTP_ADDR: :9011
      MQTT_BROKER_URL: tcp://mqtt:1883
      SOUL_API_BASE_URL: http://soul-server:9010
    depends_on:
      soul-server:
        condition: service_started
      mqtt:
        condition: service_started
    ports:
      - "${TERMINAL_WEB_HTTP_PORT}:9011"

  emotion-server:
    build:
      context: ./emotion-server-py
      dockerfile: Dockerfile
    container_name: emotion-server
    env_file:
      - .env
    environment:
      EMOTION_MODEL_ID: ${EMOTION_MODEL_ID:-MoritzLaurer/mDeBERTa-v3-base-xnli-multilingual-nli-2mil7}
      HF_HOME: /models
    ports:
      - "${EMOTION_HTTP_PORT:-9012}:9012"
    volumes:
      - ${EMOTION_MODEL_CACHE_DIR:-./.cache/huggingface}:/models

  intent-filter:
    build:
      context: ./intent-filter-py
      dockerfile: Dockerfile
    container_name: intent-filter
    env_file:
      - .env
    environment:
      INTENT_FILTER_DEFAULT_LOCALE: ${INTENT_FILTER_DEFAULT_LOCALE:-zh-CN}
      INTENT_FILTER_DEFAULT_TIMEZONE: ${INTENT_FILTER_DEFAULT_TIMEZONE:-Asia/Shanghai}
    ports:
      - "${INTENT_FILTER_HTTP_PORT:-9013}:9013"

volumes:
  postgres-data:
  mem0-postgres-data:
  mem0-neo4j-data:
