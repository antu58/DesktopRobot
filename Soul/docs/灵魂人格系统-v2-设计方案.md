# 灵魂人格系统 v2 设计方案（MBTI + PAD 动力学）

更新时间：2026-02-22  
状态：`实施中`

## 1. 目标

本方案用于重构机器人“灵魂人格系统”，满足以下业务目标：

1. 灵魂必须先创建再连接使用，创建阶段由用户选择 MBTI。
2. MBTI 自动映射为人格参数向量 `T = (empathy, sensitivity, stability, expressiveness, dominance)`。
3. 会话运行时维护灵魂动态情绪 `PAD`，并接收用户情绪冲击。
4. 任务执行受情绪门控，情绪极端时执行概率指数级下降。
5. 支持长期 PAD 统计对人格产生缓慢偏移，但不改变 MBTI 标签本体。

## 2. 总体流程

1. 用户创建灵魂（`name + mbti_type`），服务端生成并存储人格向量 `T` 与初始 PAD 状态。
2. 终端连接时选择灵魂（terminal -> soul 绑定）。
3. 收到输入（当前支持 `keyboard_text`/`speech_text`）后：
   - 调 emotion-service 获取用户情绪 `(emotion, p, a, d, intensity)`。
   - 使用人格动力学引擎更新灵魂 PAD。
   - 向端侧发布 `emotion_update`。
   - 调 intent-filter（基于终端上报 intent_catalog）做意图识别。
   - 命中可执行意图时发布 `intent_action` 到端侧。
4. 未命中可执行意图时回退到 LLM 工具编排链路，工具调用仍受情绪执行门控约束。
5. 无新输入时，服务端按固定周期（默认 3 秒，范围 2~5 秒）执行一次“自然演化 -> 持久化 -> emotion_update 下发”。

## 3. MBTI 到人格向量 T

### 3.1 量纲定义

所有维度统一 `0~1`：

- `empathy`：对他人情绪响应强度
- `sensitivity`：被情绪触发容易程度
- `stability`：恢复速度与抗波动能力
- `expressiveness`：外显程度
- `dominance`：控制/主导倾向

### 3.2 生成公式

采用“基线 + 维度偏置”：

\[
T = clamp(T_0 + B_{EI} + B_{SN} + B_{TF} + B_{JP}, 0, 1)
\]

- `T0 = (0.5, 0.5, 0.5, 0.5, 0.5)`
- 维度偏置（正位为 E/S/T/J，反位取相反数）：
  - `EI`: `(0.00, -0.03, 0.00, +0.20, +0.10)`
  - `SN`: `(-0.02, +0.08, +0.06, -0.03, +0.03)`
  - `TF`: `(-0.15, -0.05, +0.08, -0.05, +0.12)`
  - `JP`: `(0.00, -0.03, +0.15, -0.02, +0.08)`

## 4. 动态 PAD 引擎

运行时状态：

- 主状态：`x = (P, A, D)`
- 慢变量：`b`（无聊度）、`s`（冲击负荷）、`m`（极端记忆）
- 长期统计：`muP, muA, muD, volatility`
- 长期人格偏移：`ΔT_long`

### 4.1 目标情绪点

\[
x^* = (1-b)\cdot x_{neutral}(T_{eff}) + b\cdot x_{bored}
\]

- `x_bored = (-0.35, -0.45, -0.15)`
- `T_eff = clamp(T_base + ΔT_long, 0, 1)`

### 4.2 用户情绪冲击

\[
\Delta x_{user} = c \cdot I \cdot k(T_{eff}) \cdot v_{user}
\]

- `c`：模型置信度（当前取 intensity）
- `I`：输入强度（0~1）
- `v_user = (p, a, d)`（用户情绪 PAD）
- `k(T) = k_0 \cdot \frac{(0.5+empathy)(0.5+sensitivity)}{0.7+stability}`
- 单次冲击做范数上限裁剪 `||Δx_user|| <= δ_max`

### 4.3 恢复与冲击负荷

\[
s_{t+\Delta}=s_t e^{-\Delta/\tau_s(T)}+\max(0,\|\Delta x_{user}\|-\theta)
\]
\[
x_{t+\Delta}=clip\big(x_t+\Delta x_{user}+\lambda(T,s)(x^*-x_t)\Delta,-1,1\big)
\]
\[
\lambda(T,s)=\lambda_0\cdot\frac{0.5+stability}{1+1.5s}
\]

## 5. 情绪极端时执行概率抑制

先定义极端度：

\[
z = \max(|P|, |A|, |D|)
\]
\[
z_n = clamp\left(\frac{z-\tau}{1-\tau}, 0, 1\right)
\]

执行概率：

\[
P_{exec} = P_{base}\cdot\exp\left(-\alpha z_n^\beta - \eta m - \xi s\right)
\]

- 推荐：`β = 3`（临近极端区更陡）
- `τ, α` 由人格调节（`sensitivity`↑ -> 抑制增强，`stability`↑ -> 抑制减弱）

执行分层（当前实现为二态）：

- `P_exec >= execute_threshold(T)`：`auto_execute`
- `P_exec < execute_threshold(T)`：`blocked`

其中 `execute_threshold(T)` 为人格相关阈值（高稳定/高韧性更易执行，高敏感/高反应更易阻断）。

锁定与衰减机制（当前实现）：

- 重置触发条件（仅负向主导时生效）：
  - `negative_polarity >= 0.35`
  - 且 `negative_polarity >= 1.08 * positive_polarity`
  - 且 `z >= 0.95` 或 `s >= 0.90`
- 首次触发：锁定 `120s`（`LockBaseSeconds`）
- 锁定期间再次触发：在剩余锁定时长上追加 `refresh_seconds`（人格与严重度相关，默认约 `18~48s`）
- 未触发重置且仍在锁定：若输入呈正向安抚（如 `joy/gratitude/relief/calm`），按比例缩短剩余锁定时长
  - `reduction_ratio = lerp(0.20, 0.75, soothe_strength)`
  - 即每次可缩短当前剩余时长的 `20%~75%`
- 自然衰减与正向缩短可叠加：
  - 自然衰减来自时间流逝（剩余秒数持续下降）
  - 正向安抚在当轮对“当前剩余秒数”再做比例扣减

## 6. 长期 PAD 对人格偏移

采用慢变量日常化更新，不直接重写 MBTI：

\[
\Delta T_{t+1}=clip\left((1-\gamma)\Delta T_t+\eta q_t,\,-d_{max},\,d_{max}\right)
\]

- `q_t` 由长期统计构成（`muP/muA/muD/volatility/s/m`）
- `ΔT_long` 上限建议 `d_max = 0.22`
- 目标：人格“可塑但不突变”

## 7. 协议与数据模型

## 7.1 MQTT 新消息

- `.../emotion_update`：服务端下发用户情绪、灵魂 PAD、执行门控结果
- `.../intent_action`：服务端下发命中意图及参数（端侧直接执行）

## 7.2 灵魂存储模型（souls 表）

核心字段：

- `mbti_type`（如 `INFJ`）
- `personality_vector`（JSONB）
- `emotion_state`（JSONB，含 PAD+慢变量）
- `model_version`（`persona-pad-v2`）

## 8. 数据迁移与历史清理

本次重构不提供对外“管理清库 API”。  
历史数据清理采用一次性 SQL 脚本执行（见 `scripts/reset_soul_history.sql`）：

1. 清空历史会话与旧灵魂数据。
2. 保留新 schema。
3. 按新模型重新创建灵魂并绑定终端。

## 9. 可观测性建议

- 情绪链路：`emotion_latency_ms`, `intent_filter_latency_ms`
- 状态链路：`p/a/d`, `b/s/m`, `exec_probability`, `exec_mode`
- 任务链路：`intent_decision`, `intent_action_publish_ok`, `skill_invocation_gate`

## 10. 风险与控制

1. 误识别导致误抑制：通过置信度门控 + 单次冲击上限缓解。
2. 频繁锁定体验差：通过“120s基线 + 重触发增量 + 正向安抚缩时 + 自然衰减”缓解。
3. 长期偏移漂移失控：通过 `d_max` 硬限制与遗忘项 `γ` 控制。

## 11. 当前实现落地点

- `soul-server` 新增：
  - `GET /v1/souls`（列灵魂）
  - `POST /v1/souls`（创建灵魂）
  - `POST /v1/souls/select`（选择灵魂绑定终端）
- `/v1/chat` 主链路已接入：
  - emotion-service
  - PAD 动力学引擎
  - intent-filter + intent_action MQTT 下发
  - 执行概率门控
- `terminal-web` 已支持：
  - `intent_catalog` 上报
  - `emotion_update` / `intent_action` 订阅与调试展示
