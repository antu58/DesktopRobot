# Soul 目标方案（实时对话 + 异步记忆）

更新时间：2026-02-20
状态：实施中（Phase 1）

## 1. 目标

- 主链路优先实时性：`/v1/chat` 不再依赖 Mem0 的同步读写。
- 对话上下文清晰：每轮注入固定灵魂性格、技能表、历史压缩摘要、最新输入信息。
- 记忆异步化：用户空闲 3 分钟后触发会话总结，并异步进入 Mem0 记忆处理链路（队列化，非阻塞）。

## 2. 端到端流程

1. 终端首次连接，通过 MQTT 上报技能快照（`skills`）。
2. 每轮交互统一上报 `inputs[]`（文本、传感器、媒体引用）。
3. 媒体类输入先由终端上传 OSS，再把地址和元数据放进 `inputs[]`。
4. 服务端按需从 OSS 拉取并做文字化处理（ASR/VLM/视频摘要），生成 `ObservationDigest`。
5. 调用 LLM：
   - 系统提示词：灵魂性格 + 历史压缩摘要 + 本轮观测摘要
   - 用户消息：最新用户输入（文本）
   - 工具：终端技能表（MQTT 上报）
6. 返回：
   - 文本回复
   - 技能调用结果（技能名与参数）
   - 最新压缩摘要（`context_summary`）
7. 服务端持久化消息、技能执行结果和会话摘要。
8. 若 3 分钟无新用户输入，触发异步总结任务并写入 Mem0 异步队列（后续处理策略可扩展）。

## 3. MQTT 通道

- 设备在线：`{prefix}/terminal/{terminalId}/online`
- 设备心跳：`{prefix}/terminal/{terminalId}/heartbeat`
- 技能快照：`{prefix}/terminal/{terminalId}/skills`
- 技能调用下发：`{prefix}/terminal/{terminalId}/invoke/{requestId}`
- 技能执行结果：`{prefix}/terminal/{terminalId}/result/{requestId}`

说明：
- 设备心跳用于设备可达性。
- 会话活跃判定由 `/v1/chat` 用户输入触发（3 分钟 idle 计时）。

## 4. 上下文策略

- 历史会话不直接全量注入。
- 默认携带“压缩摘要 + 最近若干条消息”。
- 使用较大压缩阈值，避免短会话频繁压缩影响实时性。
- 建议阈值：
  - 消息阈值：80（可配）
  - 字符阈值：12000（可配）

## 5. Mem0 策略

- 主链路禁用 Mem0 同步检索/写入。
- 仅在异步路径使用 Mem0（当前先写入队列，处理策略后续细化）。
- 即使 Mem0 不可达，聊天主链路不受影响。

## 6. API 返回要求

`POST /v1/chat` 响应新增：
- `executed_skills`: 本轮实际执行的技能
- `context_summary`: 当前会话最新压缩摘要

## 7. 协议标准

- 统一通信协议定义见：`../../doc/通信协议-v2.md`。
- API 定义见：`API文档-Soul服务.md`。
- 本文档描述目标流程；全局协议文档描述字段级约束与兼容策略。
