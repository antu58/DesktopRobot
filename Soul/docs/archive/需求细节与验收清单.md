# Soul 项目需求细节与验收清单（冻结版）

更新时间：2026-02-20

## 1. 业务目标

构建一个面向桌面机器人场景的后端服务，支持：

- 多终端（躯体）接入
- 每个终端与一个灵魂（性格+记忆）形成可持续的运行时组合
- 通过 LLM 判断并触发终端技能
- 通过 MQTT 与终端通信
- 主链路保障实时性（不依赖 Mem0 同步调用）
- 会话 3 分钟空闲后触发异步总结，并进入 Mem0 异步记忆队列（策略可后续演进）

## 2. 架构与边界

### 2.1 服务组成

- `soul-server`（Go）
  - 对外提供聊天入口
  - 管理终端-灵魂绑定
  - 通过 MQTT 下发技能调用
  - 写入会话与消息
  - 基于“历史压缩摘要 + 最新输入”构建 LLM 上下文
  - 空闲总结后写入 Mem0 异步队列（不阻塞聊天）
  - 接入 LLM（OpenAI 兼容 + Claude）
- `terminal-web`（Go，调试终端）
  - 模拟一个终端设备
  - 启动后通过 MQTT 上报技能
  - 接收技能调用并执行
  - 提供简单 Web UI 用于调试
- `mem0`（Python/FastAPI）
  - 本地部署记忆服务
  - 暴露 `/memories` 与 `/search`
- `postgres`（业务库）
- `mem0-postgres`（pgvector）
- `mem0-neo4j`（图存储，兼容 Mem0 图能力）
- `mqtt`（Eclipse Mosquitto）

### 2.2 通信关系

- 终端 <-> 后端：MQTT
- 调试页 -> 后端：HTTP
- 后端 -> Mem0：异步任务（非聊天主链路）
- 后端 -> LLM：OpenAI 兼容/Claude API

## 3. 功能需求（明确口径）

### 3.1 多终端与灵魂绑定

- 绑定维度：`(user_id, terminal_id)`。
- 首次出现的终端：
  - 需要创建或匹配一个灵魂（可带 `soul_hint`）。
- 后续同一 `(user_id, terminal_id)`：
  - 必须复用已绑定灵魂，不被新 hint 覆盖。

### 3.2 MQTT 通信层

- 终端上线、设备心跳、技能快照通过 MQTT 上报。
- 后端根据终端技能快照维护内存态技能注册表。
- 技能调用通过 MQTT 下发，终端回传执行结果。
- 用户活跃判定以 `/v1/chat` 的用户输入为准；每次新输入重置 3 分钟空闲计时。

### 3.2.1 标准输入协议（v2）

- 对话输入统一为 `inputs[]`，不再长期使用独立 `message` 字段。
- `inputs[]` 支持：`keyboard_text`、`speech_text`、`presence`、`sensor_state`、`audio`、`image`、`video`、`event_note`。
- 媒体输入（`audio/image/video`）流程：
  1. 终端先上传 OSS。
  2. 请求只携带 OSS 地址与元数据。
  3. 服务端按需拉取并文字化（ASR/VLM/视频摘要）。
- 该协议作为全局通信协议，详见 `../../doc/通信协议-v2.md`（Soul/Body 共用）。
- API 说明详见 `API文档-Soul服务.md`。
- 当前实现阶段：Phase 1，主链路仅处理 `keyboard_text`。

### 3.3 技能注入层

- 技能来自终端上报，不写死在数据库。
- 不同终端可以上报不同技能集合。
- 终端升级后技能可变，后端应按最新有效快照生效。
- 支持 `skill_version`：
  - 新版本覆盖旧版本
  - 低版本快照不得回滚高版本能力

### 3.4 LLM 访问层

- 支持 OpenAI 兼容格式调用（当前主用）。
- 支持 Claude（Anthropic）调用。
- 终端调试场景中，LLM 根据用户表达是否正确触发：
  - 正确 -> `light_green`
  - 错误 -> `light_red`

### 3.5 记忆层（会话摘要 + Mem0 异步）

- 主链路只使用本地会话消息与压缩摘要，不同步访问 Mem0。
- 会话上下文注入规则：
  - 灵魂画像（固定提示）
  - 历史压缩摘要（适量）
  - 最新用户输入与传感器文字化结果
- 压缩策略：
  - 默认使用较大阈值（消息条数/字符数）触发，避免频繁压缩。
- 空闲策略：
  - 用户活跃超时（默认 3 分钟）触发一次异步总结。
  - 异步总结进入 Mem0 记忆队列（后续再定义落库/检索策略）。

### 3.6 调试 Web 服务

- 与 Go 后端同目录部署。
- 提供两个最小技能：
  - `light_red`（亮红灯）
  - `light_green`（亮绿灯）
- 提供最小页面：
  - 输入消息
  - 查看终端灯状态与日志

## 4. 配置与部署需求

- 数据库：PostgreSQL。
- 本地部署方式：Docker Compose。
- 一键部署脚本：`deploy_local.sh`。
- 配置管理：
  - API Key、连接信息统一走 `.env`
  - `docker-compose.yml` 从 `.env` 读取必要配置
- 端口策略：
  - 核心服务端口使用 `9000+`（当前为 `9010/9011`）
  - Mem0 当前映射 `18000`

## 5. 当前关键配置（已落地）

- OpenAI 兼容网关：
  - Base URL: `https://api.newcoin.tech/v1`
  - Model: `doubao-seed-1-6-251015`
- Mem0：
  - LLM 模型同上
  - Embedding Provider: `fastembed`
  - Embedding Model: `thenlper/gte-large`

## 6. 验收清单

- A01：Docker 一键部署成功，核心容器全部启动并健康。
- A02：OpenAI 兼容模型可达性通过（`/models` + `/chat/completions`）。
- A03：调试终端“正确语句”触发绿灯技能。
- A04：调试终端“错误语句”触发红灯技能。
- A05：终端状态页可观测到灯状态与技能执行日志。
- A06：第二终端首次接入可建立绑定；后续同终端不更换灵魂。
- A07：技能来源于终端上报，数据库中无技能定义持久化表。
- A08：`skill_version` 生效，低版本快照不会回滚高版本技能。
- A09：聊天主链路在 Mem0 不可达时仍可用（无同步依赖）。
- A10：3 分钟用户空闲可触发异步总结并产生 Mem0 异步任务记录。
