# Soul 项目验收测试报告（历史版本）

测试时间：2026-02-16  
测试环境：本机 Docker（`deploy_local.sh` 部署）

> 说明：本报告对应 2026-02-16 的旧版本（Mem0 同步主链路）。  
> 最新目标方案与口径以 `../目标方案-实时对话与异步记忆.md` 为准。

## 1. 测试结果总览

- 结论：核心需求已实现，验收项全部通过。
- 备注：`mem0` 首次构建/重建时会初始化本地 embedding 模型，耗时明显增加；完成后可正常服务。

## 2. 验收项明细

| 编号 | 验收项 | 结果 | 证据摘要 |
|---|---|---|---|
| A01 | 一键部署与容器健康 | 通过 | `docker compose ps` 显示 `mem0/soul-server/terminal-web/postgres/mqtt` 全部 `Up`；`/docs` 与 `/healthz` 正常 |
| A02 | OpenAI 兼容模型可达 | 通过 | `scripts/test_model_reachability.py`：`GET /v1/models=200`，`POST /v1/chat/completions=200` |
| A03 | 正确语句触发绿灯 | 通过 | `/ask` 返回 `executed_skills=[\"light_green\"]`，HTTP 200 |
| A04 | 错误语句触发红灯 | 通过 | `/ask` 返回 `executed_skills=[\"light_red\"]`，HTTP 200 |
| A05 | 终端状态可观测 | 通过 | `/state` 返回 `color=red`、`last_action=亮红灯`、并含执行日志 |
| A06 | 多终端绑定稳定 | 通过 | `terminal-debug-02` 首次上报后绑定 `soul_3a1...`；再次上报不同 `soul_hint` 仍为同一 `soul_id` |
| A07 | 技能不落库 | 通过 | 业务库表仅有 `memory_episode/messages/sessions/souls/terminal_soul_bindings`，无 skill 表 |
| A08 | skill_version 防回滚 | 通过 | `terminal-debug-02` 上报 v2 后再上报 v1，日志仍显示 `skill_version=2` |
| A09 | Mem0 必须启用 | 通过 | 停止 `mem0` 后 `/ask` 直接失败（500，mem0 连接错误）；恢复 `mem0` 后 `/ask` 恢复成功 |

## 3. 关键修复记录（本轮）

- 新增模型可达性脚本：`/Users/zhangfeng/Desktop/Linux/DesktopRobot/Soul/scripts/test_model_reachability.py`
- Mem0 支持从环境切换 embedding provider（当前使用 `fastembed`）
- 修复 fastembed 向 pgvector 写入 `ndarray` 类型错误（转为 list）
- 调整 Mem0 超时配置（当前 `MEM0_TIMEOUT_SECONDS=180`）

## 4. 当前生效配置（关键项）

- `OPENAI_BASE_URL=https://api.newcoin.tech/v1`
- `LLM_MODEL=doubao-seed-1-6-251015`
- `MEM0_LLM_MODEL=doubao-seed-1-6-251015`
- `MEM0_EMBED_PROVIDER=fastembed`
- `MEM0_EMBED_MODEL=thenlper/gte-large`

## 5. 回归命令（复测入口）

- 部署：`/Users/zhangfeng/Desktop/Linux/DesktopRobot/deploy_local.sh up`
- 模型连通性：  
  `python3 /Users/zhangfeng/Desktop/Linux/DesktopRobot/Soul/scripts/test_model_reachability.py --base-url https://api.newcoin.tech/v1 --model doubao-seed-1-6-251015 --api-key <YOUR_KEY>`
- 绿灯用例：  
  `curl -X POST http://localhost:9011/ask -H 'content-type: application/json' -d '{"session_id":"acc-green","message":"地球绕太阳公转，这句话正确吗？"}'`
- 红灯用例：  
  `curl -X POST http://localhost:9011/ask -H 'content-type: application/json' -d '{"session_id":"acc-red","message":"太阳围绕地球公转，这句话正确吗？"}'`
