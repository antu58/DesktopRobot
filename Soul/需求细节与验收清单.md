# Soul 项目需求细节与验收清单（冻结版）

更新时间：2026-02-16

## 1. 业务目标

构建一个面向桌面机器人场景的后端服务，支持：

- 多终端（躯体）接入
- 每个终端与一个灵魂（性格+记忆）形成可持续的运行时组合
- 通过 LLM 判断并触发终端技能
- 通过 MQTT 与终端通信
- 使用 Mem0 作为记忆层（必须启用，不做降级）

## 2. 架构与边界

### 2.1 服务组成

- `soul-server`（Go）
  - 对外提供聊天入口
  - 管理终端-灵魂绑定
  - 通过 MQTT 下发技能调用
  - 写入会话与消息
  - 接入 Mem0 做记忆写入/检索
  - 接入 LLM（OpenAI 兼容 + Claude）
- `terminal-web`（Go，调试终端）
  - 模拟一个终端设备
  - 启动后通过 MQTT 上报技能
  - 接收技能调用并执行
  - 提供简单 Web UI 用于调试
- `mem0`（Python/FastAPI）
  - 本地部署记忆服务
  - 暴露 `/memories` 与 `/search`
- `postgres`（业务库）
- `mem0-postgres`（pgvector）
- `mem0-neo4j`（图存储，兼容 Mem0 图能力）
- `mqtt`（Eclipse Mosquitto）

### 2.2 通信关系

- 终端 <-> 后端：MQTT
- 调试页 -> 后端：HTTP
- 后端 -> Mem0：HTTP
- 后端 -> LLM：OpenAI 兼容/Claude API

## 3. 功能需求（明确口径）

### 3.1 多终端与灵魂绑定

- 绑定维度：`(user_id, terminal_id)`。
- 首次出现的终端：
  - 需要创建或匹配一个灵魂（可带 `soul_hint`）。
- 后续同一 `(user_id, terminal_id)`：
  - 必须复用已绑定灵魂，不被新 hint 覆盖。

### 3.2 MQTT 通信层

- 终端上线、心跳、技能快照通过 MQTT 上报。
- 后端根据终端技能快照维护内存态技能注册表。
- 技能调用通过 MQTT 下发，终端回传执行结果。

### 3.3 技能注入层

- 技能来自终端上报，不写死在数据库。
- 不同终端可以上报不同技能集合。
- 终端升级后技能可变，后端应按最新有效快照生效。
- 支持 `skill_version`：
  - 新版本覆盖旧版本
  - 低版本快照不得回滚高版本能力

### 3.4 LLM 访问层

- 支持 OpenAI 兼容格式调用（当前主用）。
- 支持 Claude（Anthropic）调用。
- 终端调试场景中，LLM 根据用户表达是否正确触发：
  - 正确 -> `light_green`
  - 错误 -> `light_red`

### 3.5 记忆层（Mem0）

- Mem0 必须启用，不允许“失败自动降级”。
- 会话消息写入本地 DB，并同步写入 Mem0。
- 构建回复前从 Mem0 检索语义记忆注入上下文。
- 当前部署采用：
  - LLM：OpenAI 兼容网关模型
  - Embedding：本地 `fastembed`（规避网关不支持 OpenAI embedding 模型）

### 3.6 调试 Web 服务

- 与 Go 后端同目录部署。
- 提供两个最小技能：
  - `light_red`（亮红灯）
  - `light_green`（亮绿灯）
- 提供最小页面：
  - 输入消息
  - 查看终端灯状态与日志

## 4. 配置与部署需求

- 数据库：PostgreSQL。
- 本地部署方式：Docker Compose。
- 一键部署脚本：`deploy_local.sh`。
- 配置管理：
  - API Key、连接信息统一走 `.env`
  - `docker-compose.yml` 从 `.env` 读取必要配置
- 端口策略：
  - 核心服务端口使用 `9000+`（当前为 `9010/9011`）
  - Mem0 当前映射 `18000`

## 5. 当前关键配置（已落地）

- OpenAI 兼容网关：
  - Base URL: `https://api.newcoin.tech/v1`
  - Model: `doubao-seed-1-6-251015`
- Mem0：
  - LLM 模型同上
  - Embedding Provider: `fastembed`
  - Embedding Model: `thenlper/gte-large`

## 6. 验收清单

- A01：Docker 一键部署成功，核心容器全部启动并健康。
- A02：OpenAI 兼容模型可达性通过（`/models` + `/chat/completions`）。
- A03：调试终端“正确语句”触发绿灯技能。
- A04：调试终端“错误语句”触发红灯技能。
- A05：终端状态页可观测到灯状态与技能执行日志。
- A06：第二终端首次接入可建立绑定；后续同终端不更换灵魂。
- A07：技能来源于终端上报，数据库中无技能定义持久化表。
- A08：`skill_version` 生效，低版本快照不会回滚高版本技能。
- A09：记忆链路启用且可用（Mem0 接口可访问并参与聊天流程）。
