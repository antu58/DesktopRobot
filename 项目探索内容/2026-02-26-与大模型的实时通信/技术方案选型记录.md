# 技术方案选型记录（2026-02-26）

## 1. 目标

围绕“桌面助手 24 小时待机 + 连续对话 + 会议纪要沉淀”建设一套统一底座：

1. 一套实时引擎（统一接入、统一编排、统一权限与审计）。
2. 两种工作流并行：对话流（实时交互）和纪要流（会议沉淀）。
3. 保证可私有化部署、可扩展、可灰度切换，不依赖 mock。

## 2. 总体技术路线

统一链路：`RTC + 流式 ASR + LLM 编排 + TTS + 工具网关 + 数据层`。

1. 对话流：低延迟识别 -> LLM 决策 -> 工具调用（按需）-> 语音播报。
2. 纪要流：同源音频转写 -> 说话人/时间轴 -> 会中摘要 -> 会后结构化输出。

## 3. 选型结论

| 模块 | 当前选型 | 备选 | 选型原因 | 当前风险/备注 |
| --- | --- | --- | --- | --- |
| 实时传输层 | WebRTC（浏览器）+ Pion（Go） | WebSocket 直传音频 | 原生低延迟、NAT/ICE 支持好，后续可扩展到视频与数据双通道 | 需要处理 ICE/STUN/TURN 生产配置 |
| 流式 ASR | FunASR（`paraformer-zh-streaming`）本地部署 | 云 ASR API | 中文实时识别成熟，可私有化，已完成单路流式链路验证 | CPU 模式延迟高，建议后续 GPU 化 |
| LLM 编排层 | 独立 Orchestrator（会话状态机 + 路由 + Function Calling） | 端侧直连单模型 | 统一承载对话流与纪要流，方便策略、权限、审计统一 | 需补齐中断策略与长会话记忆策略 |
| TTS | CosyVoice（本地服务） | 云端低延迟 TTS、ChatTTS 等 | 可本地化，支持多音色、3s 复刻、跨语种复刻、指令控制 | 当前 CPU 推理慢，长文本体验受限 |
| 工具网关 | MCP/Function Calling 网关 + 内部 HTTP API | 各服务直接互调 | 统一鉴权、超时重试、审计与幂等，降低耦合 | 需制定工具注册规范与权限模型 |
| 数据层 | PostgreSQL + Redis + 对象存储 + 向量检索 | 单库方案 | 兼顾事务、缓存、音频/转写文件存储与检索问答 | 需尽快定义数据保留与脱敏策略 |

## 4. 工作流映射

1. 对话流（实时助手）
2. 音频进入 RTC，FunASR 输出 partial/final。
3. LLM 编排判断是否调用工具。
4. 文本回复进入 CosyVoice 合成并回传播放。
5. 支持 barge-in（打断当前播报，进入新一轮）。

1. 纪要流（会议记录）
2. 同源音频进入转写与分段。
3. 会中滚动摘要、会后生成结构化纪要（结论/行动项/责任人/截止时间）。
4. 结果落库并可回写任务系统或文档系统。

## 5. 当前落地状态

1. 已完成：单路 WebRTC + 流式 FunASR + 前端实时文本回传（Docker）。
2. 已完成：CosyVoice 独立服务与网页测试页（固定端口运行）。
3. 已完成：音色复刻（含 `m4a`）与 `clone_id` 复用能力。
4. 已完成：真流式 TTS 接口 `/api/synthesize/clone/stream` 与测试页 `/stream-test`。
5. 待完成：LLM 编排层、工具网关、纪要流结构化输出、TTS 打断控制。

## 6. 当前固定端口（本地）

1. ASR Web 页面与信令：`18188/tcp`
2. ASR WebRTC ICE：`19188/udp`
3. CosyVoice 服务与网页：`18388/tcp`

## 7. 下一步实施优先级

1. 补齐 LLM 编排层最小闭环（意图路由 + 工具调用 + 会话状态）。
2. 打通“ASR 文本 -> LLM -> TTS”对话流，加入可打断机制。
3. 增加纪要流处理器（时间轴、说话人、摘要与行动项抽取）。
4. 建立统一工具网关（鉴权、限流、超时、审计）。
5. 对 FunASR/CosyVoice 做 GPU 化评估，确定生产延迟目标。
