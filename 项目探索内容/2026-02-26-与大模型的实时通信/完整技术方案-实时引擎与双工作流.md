# 完整技术方案：一套实时引擎 + 两种工作流

## 1. 方案目标

构建统一实时引擎，支持两条并行工作流：

1. 对话流：低延迟、可打断、连续对话、可工具调用。  
2. 纪要流：实时转写沉淀、会中摘要、会后结构化纪要与待办输出。  

核心技术栈：`RTC + 流式ASR + LLM编排 + TTS + 工具网关`。

## 2. 总体架构

一套实时引擎，统一接入层和编排层；在编排后分流为对话流与纪要流。

1. 实时接入层（RTC）
2. 语音理解层（流式 ASR + 可选说话人/时间戳）
3. 编排层（LLM Orchestrator）
4. 输出层（TTS + 文本字幕）
5. 工具网关（统一函数调用、权限、审计）
6. 数据层（会话事件、转写、纪要、待办、检索索引）

## 3. 双工作流设计

### 3.1 对话流（实时交互）

主目标：用户说话后尽快得到可听回复，且可被中断。

链路：

1. 端侧音频进入 RTC。
2. 流式 ASR 输出 partial/final 文本。
3. LLM 编排做意图判断、上下文拼接、工具决策。
4. 需要外部能力时走工具网关调用。
5. LLM 输出文本后进入 TTS 流式合成。
6. 音频与字幕回传端侧播放。

关键点：

1. 支持 barge-in（打断当前播报）。
2. 短回复优先，长任务异步化。
3. 控制首包延迟与整体回合时延。

### 3.2 纪要流（会议沉淀）

主目标：会中持续产出、会后结构化沉淀。

链路：

1. 同源音频流进入转写流水线（与对话流共享 ASR 基础能力）。
2. 记录说话人、时间戳、段落边界。
3. 会中滚动生成摘要（阶段性刷新）。
4. 会后输出结构化结果：结论、行动项、责任人、截止时间、风险项。
5. 写入文档系统与任务系统（通过工具网关）。

关键点：

1. 与对话流并行，不互相阻塞。
2. 纪要结果可追溯到原始时间轴与发言片段。
3. 支持检索与二次问答。

## 4. 技术环节拆分

### 4.1 RTC 层

职责：实时传输音视频/数据，保证低延迟和连接稳定。  
建议：Web 端原生 WebRTC，服务端 Pion（Go）管理会话与 ICE。

### 4.2 流式 ASR 层

职责：将音频分片实时转文字，输出 partial/final。  
建议：FunASR 流式模型作为本地/私有化主方案；按需补充说话人分离与标点模块。

### 4.3 LLM 编排层

职责：统一会话状态、策略路由、工具调用决策。  
建议能力：

1. 多策略路由（快答/深答/工具调用）。
2. 会话记忆窗口管理。
3. 对话流与纪要流共享上下文总线。

### 4.4 TTS 层

职责：将文本流式转语音并可中断。  
建议：支持分句增量播放、情绪/语速控制、回声与重叠控制。

### 4.5 工具网关

职责：统一接入内部 API/外部服务。  
必须项：

1. 鉴权与权限边界。
2. 超时、重试、幂等策略。
3. 全量审计日志（请求、响应、调用人、耗时）。

## 5. 选型建议（当前推荐）

1. 实时传输：`WebRTC + Pion(Go)`  
2. ASR：`FunASR（paraformer-zh-streaming）`  
3. 编排：`LLM Orchestrator（支持 Function Calling）`  
4. TTS：支持流式输出与打断的 TTS 服务  
5. 工具网关：`MCP/函数调用网关 + 内部 HTTP API`  
6. 数据层：`PostgreSQL + Redis + 对象存储 + 向量检索`  

## 6. 关键非功能指标（建议）

1. 对话首包延迟：目标 `< 800ms`。  
2. ASR partial 刷新周期：`200~500ms`。  
3. 单会话稳定时长：支持长时会话（小时级）。  
4. 工具调用成功率：`> 99%`（含超时降级）。  
5. 纪要完整率：行动项与责任人抽取可评测。

## 7. 里程碑实施

1. M1：实时引擎底座（RTC + ASR + TTS 基础闭环）。  
2. M2：对话流完善（连续对话、打断、工具调用）。  
3. M3：纪要流完善（说话人、时间戳、会中/会后纪要）。  
4. M4：双流融合（共享上下文、统一检索、统一权限审计）。  

## 8. 当前与你项目的对应关系

已具备基础雏形：`WebRTC + 流式 ASR + 实时文本回传 + Docker 部署`。  
下一步应优先补齐：`LLM 编排层 + TTS 层 + 工具网关 + 纪要流结构化输出`。
