# 2026-02-27 任务成果与方案总结

## 1. 任务目标

本次任务目标为：

1. 新建今日探索项目目录，形成独立可运行原型。
2. 将 `声音采集网页 + FunASR + 辅助服务` 作为“前端整体节点”。
3. 前端整体先做识别与过滤，再把结构化数据发送到 Go 后端。
4. Go 后端预留 LLM 接口（当前以 `LLM_STUB` 占位），将处理结果回传前端显示。
5. 设计面向长时间运行（FunASR 常驻 + 前后端长连接保活）。

---

## 2. 目录与交付物

项目目录：

`/Users/zhangfeng/Desktop/Linux/DesktopRobot/项目探索内容/2026-02-27-语音长时保活与结构化回传`

核心交付：

1. `edge-frontend/`：前端整体节点（Web + ASR + Filter + Backend Bridge）
2. `go-llm-backend/`：Go WebSocket 后端（LLM 占位处理）
3. `docker-compose.yml`：一键编排
4. `README.md`：运行说明

---

## 3. 架构方案（最终确认版）

数据流：

`Browser Mic -> Edge Frontend(FunASR+Filter) -> Go LLM Backend -> Edge Frontend -> Browser`

关键设计点：

1. FunASR 不放在 Go 后端，放在前端整体节点（边缘侧）。
2. Go 后端仅接收结构化语音事件，不接收原始音频流。
3. 通信主协议采用 WebSocket（双向、长连接、易保活、实现简单）。

---

## 4. 通信与协议

### 4.1 Browser -> Edge Frontend

1. WebSocket endpoint：`/ws/client`
2. 二进制消息：`16kHz PCM16LE mono`
3. 控制消息：
   - `{"event":"flush"}`
   - `{"event":"ping"}`

### 4.2 Edge Frontend -> Go Backend

WebSocket endpoint：`/ws/edge`

结构化请求字段：

1. `text`
2. `emotion`（如 `EMO_UNKNOWN`）
3. `event`（如 `Speech` / `BGM`）
4. `final`（本项目当前上送为段级 final）
5. `session_id`
6. `ts_ms`

### 4.3 Go Backend -> Edge Frontend

当前返回为占位处理结果：

`原文 + [LLM_STUB emo=... event=... final=...]`

---

## 5. 过滤策略（前端整体节点）

为降低后端压力，设置门槛：

1. `SUBMIT_MIN_TEXT_CHARS`：文本长度下限
2. `SUBMIT_REQUIRE_SPEECH=1`：仅 `event == Speech` 才上送后端
3. `SUBMIT_MIN_INTERVAL_MS`：提交间隔限流

当前运行参数（实测）：

1. `SUBMIT_MIN_TEXT_CHARS=2`
2. `SUBMIT_MIN_INTERVAL_MS=600`
3. `PRE_ROLL_MS=120`
4. `SUBMIT_REQUIRE_SPEECH=1`
5. `VAD_CHUNK_MS=200`
6. `MAX_SEGMENT_MS=30000`

---

## 6. 运行与端口

已停止旧测试栈：

1. `single-stream-asr-poc`
2. `cosyvoice-tts-playground`

本项目当前运行端口：

1. 前端整体服务：`127.0.0.1:18288`
2. Go 后端服务：`127.0.0.1:18090`

---

## 7. 实测表现与异常分析

从页面回放结果看，整体链路表现正常：

1. ASR 持续输出 `final=true` 段级结果。
2. `Speech` 事件进入后端并得到 `LLM_STUB` 回包。
3. `BGM` 等非语音事件被过滤，避免无效调用后端。
4. 限流生效，出现 `submit_interval_limited` 属预期行为。

`[filtered] not_speech_event` 的含义：

1. 该段被模型判定为非 `Speech`（例如 `BGM`）。
2. 因 `SUBMIT_REQUIRE_SPEECH=1`，所以不提交后端，仅在前端提示被过滤。

---

## 8. 长时保活设计要点

1. Edge -> Backend WebSocket 长连接 + 自动重连。
2. 双侧心跳（ping/pong）与超时控制。
3. FunASR 模型常驻，避免请求级反复加载。
4. 通过门槛过滤减小后端负担，提升长时稳定性。

---

## 9. 后续优化建议

若后续希望进一步稳态优化，可按顺序尝试：

1. `PRE_ROLL_MS=180`：减少句首截断。
2. `SUBMIT_MIN_TEXT_CHARS=3`：减少短噪声文本。
3. `SUBMIT_MIN_INTERVAL_MS=1000`：进一步降后端QPS。
4. 标签标准化：将 `EMO_UNKNOWN`、`BGM` 等映射为业务枚举。
5. LLM 接口替换：将 `LLM_STUB` 替换为真实推理调用。

